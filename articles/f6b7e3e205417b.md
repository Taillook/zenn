---
title: "Axumã§WebSocketã‚’ä½¿ã†ã¨ãã«OpenAPI Generatorã®ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ç”Ÿæˆã‚’ã™ã‚‹çŸ¥è¦‹"
emoji: "ğŸ¦€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "axum"]
publication_name: "mixi"
published: false
---

æœ€è¿‘OpenAPI Generatorã«`rust-axum`ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã®ã‚’ç™ºè¦‹ã—ã€ä»¥å‰é–‹ç™ºã—ã¦ã„ãŸWebSocketã‚µãƒ¼ãƒãƒ¼ã«é©ç”¨å‡ºæ¥ãªã„ã‹è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚


## library
axumã¨OpenAPI Generatorã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®æŒ‡å®šã‚’ã—ã¦ã„ã¾ã™ã€‚
```toml
[dependencies.axum]
version = '0.7.5'
features = [
    'ws',
]
```

OpenAPI Generator: v7.5.0

## Generateã«ä½¿ã†Yaml
ç”Ÿæˆç”¨ã®Yamlã¯ä»¥ä¸‹ã§Path Parameterã«`channel_id`ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚  
ã¾ãŸã€ç‰¹æ®Šãªè¨˜è¿°ã¨ã—ã¦`x-websocket`ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯å¾Œã§èª¬æ˜ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ä¸Šã§å¿…è¦ã«ãªã‚‹è¨˜è¿°ã§ã™ã€‚

```yaml
openapi: 3.1.0
info:
  title: WebSocket
  version: 0.0.1
servers:
- url: http://localhost:8088
paths:
  /websocket/{channel_id}:
    get:
      description: WebSocketã«æ¥ç¶šã™ã‚‹
      operationId: connectWebSocket
      x-websocket: true
      servers:
      - url: ws://localhost:8088
      parameters:
      - in: path
        name: channel_id
        required: true
        schema:
          type: string
      - in: header
        name: Connection
        required: true
        schema:
          type: string
      - in: header
        name: Upgrade
        required: true
        schema:
          type: string
      - in: header
        name: Sec-WebSocket-Key
        required: true
        schema:
          type: string
      - in: header
        name: Sec-WebSocket-Version
        required: true
        schema:
          type: string
      responses:
        "101":
          headers:
            Connection: 
              required: true
              schema:
                type: string
            Upgrade:
              required: true
              schema:
                type: string
            Sec-WebSocket-Accept:
              required: true
              schema:
                type: string
          description: 101 response
        "default":
          content:
            text/plain:
              schema:
                type: string
          description: Error response
      tags:
      - websocket
```

## ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã ã¨ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ãŒä¸ååˆ†ãªã®ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚
`x-websocket`ãŒyamlã«ã‚ã‚‹å ´åˆ`ws::WebSocketUpgrade`ã¨ã„ã†ExtractorãŒhandlerã®å¼•æ•°ã«è¿½åŠ ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

lib.mustache
```diff
--- lib.mustache.org	2024-06-18 21:44:16
+++ lib.mustache	2024-06-18 20:40:17
@@ -88,6 +88,9 @@
                 {{#x-consumes-multipart-related}}
                     body: axum::body::Body,
                 {{/x-consumes-multipart-related}}
+                {{#x-websocket}}
+                web_socket: ws::WebSocketUpgrade
+                {{/x-websocket}}
                 ) -> Result<{{{operationId}}}Response, String>;
             {{/vendorExtensions}}
```

server-operation.mustache
```diff
--- server-operation.mustache.org	2024-06-18 21:41:21
+++ server-operation.mustache	2024-06-18 20:40:17
@@ -15,6 +15,9 @@
 {{/queryParams.size}}
  State(api_impl): State<I>,
 {{#vendorExtensions}}
+{{#x-websocket}}
+ web_socket: ws::WebSocketUpgrade,
+{{/x-websocket}}
 {{^x-consumes-multipart-related}}
 {{^x-consumes-multipart}}
   {{#bodyParam}}
@@ -164,6 +167,9 @@
         query_params,
       {{/queryParams.size}}
       {{#vendorExtensions}}
+        {{#x-websocket}}
+        web_socket,
+        {{/x-websocket}}
         {{^x-consumes-multipart-related}}
         {{^x-consumes-multipart}}
           {{#bodyParams}}
```

## ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¨çµ±åˆ

Apiã¨ã„ã†ãƒˆãƒ¬ã‚¤ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã§ãã‚Œã‚’å®Ÿè£…ã—ã¦ã„ãå½¢å¼ã¨ãªã‚Šã¾ã™ã€‚  
ã‚ã¨ã¯`todo()`ã®éƒ¨åˆ†ã«WebSocketã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®streamã‚’æ‰±ã†å‡¦ç†ã‚’æ›¸ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```rust
struct ServerImpl {
   // database: sea_orm::DbConn,
}

#[allow(unused_variables)]
#[async_trait]
impl websocket::Api for ServerImpl {
    #[doc = r" ConnectWebSocket - GET /websocket/{channel_id}"]
    #[must_use]
    #[allow(clippy::type_complexity, clippy::type_repetition_in_bounds)]
    fn connect_web_socket<'life0, 'async_trait>(
        &'life0 self,
        method: Method,
        host: Host,
        cookies: CookieJar,
        header_params: models::ConnectWebSocketHeaderParams,
        path_params: models::ConnectWebSocketPathParams,
        web_socket: ws::WebSocketUpgrade,
    ) -> ::core::pin::Pin<
        Box<
            dyn ::core::future::Future<Output = Result<ConnectWebSocketResponse, String>>
                + ::core::marker::Send
                + 'async_trait,
        >,
    >
    where
        'life0: 'async_trait,
        Self: 'async_trait,
    {
        todo!()
    }
}
```

## ã¾ã¨ã‚

OpenAPI Generatorã§`rust-axum`ã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã¿ã¾ã—ãŸãŒWebSocketãªã©è¿½åŠ ã§ExtractorãŒå¿…è¦ã«ãªã£ã¦ãã‚‹å ´åˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒé »ç¹ã«å‡ºã¦ãã‚‹ã¨ã„ã£ãŸå°è±¡ã§ã—ãŸã€‚  
ã¾ãŸã€æœ€çµ‚çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦Routerã¾ã§ç”Ÿæˆã•ã‚Œã‚‹ã®`.layer`ç­‰ã‚’å¥½ããªã‚ˆã†ã«æŒ¿å…¥å‡ºæ¥ãªã„ã§ã™ã€‚ãªã®ã§ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã™ã¹ã¦ã‚’ä½¿ã†ã‹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦ç²¾æŸ»ã¯å¿…è¦ã‹ã¨æ€ã„ã¾ã™ã€‚
ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µãƒ¼ãƒãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ä¸Šã§ã¯ã¨ã¦ã‚‚ä¾¿åˆ©ã ã¨æ€ã†ã®ã§ã‚ˆã‚Šè‰¯ã„ä½¿ã„æ–¹ã‚’è¦‹ã¤ã‘ã¦ã„ã‘ãŸã‚‰ã¨æ€ã„ã¾ã—rãŸã€‚
